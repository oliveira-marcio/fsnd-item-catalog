<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script src="//apis.google.com/js/platform.js?onload=start"></script>
  </head>

  <body>
    <div id="signinButton">
      <span class="g-signin"
        data-scope="openid email"
        data-clientid="{{CLIENT_ID}}"
        data-redirecturi="postmessage"
        data-accesstype="offline"
        data-cookiepolicy="single_host_origin"
        data-callback="signInCallback"
        data-approvalprompt="force">
      </span>
    </div>

    <div id="result"></div>

    <script>
      function redirect_page(message){
        $("#result").html(message)
        setTimeout(function() {
          {% if routeCallBack == "showAllItems" %}
          window.location.href = "{{url_for(routeCallBack, category_name = category_name|lower)}}";
          {% elif routeCallBack == "showItem" %}
          window.location.href = "{{url_for(routeCallBack, category_name = category_name|lower, item_name = item.title|lower)}}";
          {% else %}
          window.location.href = "{{url_for(routeCallBack)}}";
          {% endif %}
        }, 4000);
      }

      function signInCallback(authResult) {
        if (authResult["code"]) {
          // Hide the sign-in button now that the user is authorized
          $("#signinButton").attr("style", "display: none");

          // Send the one-time-use code to the server, if the server responds, write a "login successful" message to the web page and then redirect back to the main restaurants page
          $.ajax({
            type: "POST",
            url: "/gconnect?state={{STATE}}",
            processData: false,
            data: authResult["code"],
            contentType: "application/octet-stream; charset=utf-8",
            success: function(result) {
              // Handle or verify the server response if necessary.
              let message;
              if (result) {
                message = `Login Successful!</br>${result}</br>Redirecting...`;
              } else if (authResult["error"]) {
                message = `There was an error: ${authResult["error"]}</br>Redirecting...`;
              } else {
                message = "Failed to make a server-side call. Check your configuration and console.</br></br>Redirecting...";
              }
              redirect_page(message);
            },
            error: function(result) {
              redirect_page(`Error during authentication:</br>${result}</br></br>Try again later.</br></br>Redirecting...`);
           }
          });
        }
      }
    </script>
  </body>
</html>
